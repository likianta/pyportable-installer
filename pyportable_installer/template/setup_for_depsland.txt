"""
Placeholders:
    VENV_NAME       tell depsland what venv folder name to create.
    REQUIREMENTS    list[str]. list of requirements with specifiers.
    VENV_ID         venv id.
    LAUNCHER        main launcher name.
    OFFLINE         bool[False]. set pip offline mode.
    LOCAL_DIR       str. if offline enabled, the local should be a valid path
                    which contains '*.whl' files.
    INVISIBLE       show console or not.
See `pyportable_installer.main_flow.step3.step3_3.create_launcher
    ._create_depsland_setup`

Workflow:
    1. import depsland
    2. depsland create venv
    3. generate exe
    4. delete setup.bat
"""
import os
import sys
import shutil
import traceback

from os.path import abspath
from os.path import dirname
from os.path import exists
from os.path import normpath

os.chdir(dirname(__file__))

assert os.getenv('DEPSLAND')
sys.path.insert(0, os.getenv('DEPSLAND'))

try:
    from depsland import launch
    from depsland.setup import bat_2_exe
    from lk_utils import loads, dumps, find_files
except ImportError:
    print(traceback.format_exc())
finally:
    input('[Setup Failed] Press enter or close the window ...')
    sys.exit()


def main(offline={OFFLINE}, local=r'{LOCAL_DIR}'):
    if offline and exists(local):
        from depsland_additional_tools import indexing_local_packages
        indexing_local_packages.main(local)
        # shutil.rmtree(local)

    # create depsland venv
    venv_dir = launch(
        "{VENV_NAME}",
        {REQUIREMENTS},
        venv_id="{VENV_ID}"
    )

    # generate launcher
    launcher = loads('{LAUNCHER}.bat')
    launcher = launcher.format(PYTHON=normpath(f'{{venv_dir}}/python.exe'))
    dumps(launcher, '{LAUNCHER}.tmp.bat')

    if exists('launcher.ico'):
        icon = abspath('launcher.ico')
    else:
        icon = ''
    bat_2_exe(abspath('{LAUNCHER}.tmp.bat'), abspath('../{LAUNCHER}.exe'),
              icon, '{INVISIBLE}')

    # move setup file to build dir
    if exists('./setup.bat'):
        os.remove('./setup.bat')
    shutil.move('../setup.bat', './setup.bat')


try:
    main()
except Exception:
    print(traceback.format_exc())
    input('[Setup Failed] Press enter or close the window ...')
finally:
    input('[Setup Succeed] Press enter or close the window ...')
